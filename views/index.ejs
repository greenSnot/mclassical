<html>
    <meta charset="utf-8">
    <meta name="format-detection" content="telephone=no">
    <meta name="viewport" content=" user-scalable=no, initial-scale=1.0,minimum-scale=1.0, maximum-scale=1.0">
    <meta name="author" content="Calculon 0x00111111@gmail.com">
    <head>
        <link rel="stylesheet" type="text/css" href="css/mclassical.css">
        <script src='js/mclassical-base.js'></script>
        <script src='js/mclassical-pano.js'></script>
        <title>古典音乐放大镜</title>
    </head>
<body>
        <span id="__getwidth"></span>
        <div id="head">
            <div id="logo">
                <div id="search-wrap" class="start">
                    <input id="search">
                    <button id="btn-search"><%=language.search%></button>
                </div>
                <div id="result-wrap">
                    <div id="result-stick">
                    </div>
                    <div id="result">
                        <div class="tabs">
                            <div data-type="scores" class="tab selected"><%=language.scores%></div>
                            <div data-type="videos" class="tab"><%=language.videos%></div>
                            <div data-type="audios" class="tab"><%=language.audios%></div>
                        </div>
                        <div id="result-content">
                        </div>
                    </div>
                </div>
                <div id="introduction-wrap">
                    <div id="introduction-stick">
                    </div>
                    <div id="introduction">
                        <div id="introduction-title">dsf</div>
                        <div id="introduction-content">
                            introduction
                        </div>
                    </div>
                </div>
                <div class="other-wrap volunteer">
                    <div class="other-stick">
                        <%=language.volunteer%>
                    </div>
                </div>
                <div class="other-wrap about">
                    <div class="other-stick">
                        <%=language.about%>
                    </div>
                </div>
                <div class="other-wrap help">
                    <div class="other-stick">
                        <%=language.help%>
                    </div>
                </div>
                <div id="magnifier">
                    <div id="stick">
                    </div>
                </div>
            </div>
        </div>

        <div id="pano">
            <div id="container">
                <div id="camera">
                </div>
            </div>
        </div>
        <div id="music-details">
             <div id="music-wrap">
                 <div id="music-album">
                     <div id="music-album-full"></div>
                 </div>
                 <div id="music-info-wrap">
                     <div id="music-info">
                         <div id="music-songname">songname</div>
                         <div id="music-singer">singer</div>
                         <div id="music-albumname">albumname</div>
                     </div>
                     <div id="music-more"><%=language.more%></div>
                 </div>
             </div>
        </div>

    <audio id="audio" autoplay="autoplay" style="width:0;height:0;visibility:hidden" ></audio>
</body>
<script src="/js/template-native.js"></script>
<script id="template-result" type="text/html">
    <#if(
    (scores&&scores.length==0)&&
    (videos&&videos.length==0)&&
    (audios&&audios.length==0)){#>
        <%=language.noResult%>
    <#}#>
    <#for(var i in scores){#>
        <a class="result-score" target="_Blank" href="<#=scores[i].link#>"><#=scores[i].title#></a>
    <#}#>
    <#for(var i in videos){#>
        <a class="result-video" data-id="<#=videos[i].id#>" target="_Blank" data-title="<#=videos[i].title#>" data-link="<#=videos[i].link#>"><img class="result-video-img" width="150"src="<#=videos[i].thumbnail#>"><div class="video-info"><#=videos[i].title#></div></a>
    <#}#>
    <#for(var i in audios){#>
        <a class="result-audio"  target="_Blank" href="<#=audios[i].m4a#>">
            <img class="result-audio-img" width="150" height="150" src="<#=audios[i].albumpic_big#>">
            <div class="audio-info">
                <div><#=audios[i].songname#></div>
                <div><#=audios[i].albumname#></div>
                <div><#=audios[i].singername#></div>
            </div>
        </a>
    <#}#>
</script>
<script type="text/javascript" src="http://player.youku.com/jsapi">
</script>
<script id="template-youku" type="text/html">
    <div id="youkuplayer" style="height:<#=width#>px;width:<#=height#>px;display:block;"></div>
</script>
<script>
        template.config('openTag','<#');
        template.config('closeTag','#>');

        var height=window.innerHeight;
        var width=window.innerWidth;
        $('#result').width(width-30);
        $('#result').height(height-100);
        $('#introduction').width(width-30);
        $('#introduction').height(height-100);
        $('#search').width(width-53);

        $('#search-wrap').removeClass('start');
        $('#search-wrap').addClass('show');

        var stopSearchAnimation=false;
        function getTextWidth(str,fontsize) {
            var d = document.getElementById('__getwidth');
            d.style.fontSize=fontsize;
            d.innerHTML = str;
            return d.offsetWidth;
        }

        var autoTyping=[
            'The magnifier of classical music'
        ];

        function searchPost(){
            $('#result-content').html('<div id="result-loading-wrap"><div id="result-loading"></div></div>');
            $.post('/search',{
                    type:$('.tab.selected').attr('data-type'),
                    keyword:$('#search').val()
                },
                function(res){
                    if(res.code!=0){
                        alert(res.msg);
                        return;
                    }
                    $('#result-content').html(template('template-result',res));
            });
        }

        function search(keyword){
            $('#search').blur();
            $('#search-wrap').addClass('show');
            if($('#result-wrap').hasClass('show')){
                $('#result-wrap').removeClass('show');
                setTimeout(function(){
                        $('#result-wrap').addClass('show');
                },500);
            }else{
                $('#result-wrap').addClass('show')
            }
            searchPost();
        }

        var inputstr='';
        function changeInput(inputstr){
            return function(){
                if(!stopSearchAnimation){
                    $('#search').val(inputstr);
                }
            }
        }

        var delay=0;
        for(var i in autoTyping){
            $('#search').val('');
            inputstr='';
            for(var j in autoTyping[i]){
                inputstr+=autoTyping[i][j];
                delay+=100;
                setTimeout(changeInput(inputstr),delay);
            }
        }


        var QQMusicUrls=JSON.parse('<%-JSON.stringify(QQMusicUrls)%>');

        var Musics={};
        var ri=0;
        var rj=-70;
        var zindex=0;
        for(var i in QQMusicUrls){
            $.get(QQMusicUrls[i],function(res){
                res=JSON.parse(res);
                if(res.showapi_res_body&&res.showapi_res_body.pagebean&&res.showapi_res_body.pagebean.contentlist){
                    var clist=res.showapi_res_body.pagebean.contentlist;
                    for(var j in clist){
                        if(j>14)break;
                        Musics['QQMusic_'+clist[j].songid]={};
                        Musics['QQMusic_'+clist[j].songid].songid=clist[j].songid;
                        Musics['QQMusic_'+clist[j].songid].songname=decodeURI(clist[j].songname);
                        Musics['QQMusic_'+clist[j].songid].singer=decodeURI(clist[j].singername);
                        Musics['QQMusic_'+clist[j].songid].albumname=decodeURI(clist[j].albumname);
                        Musics['QQMusic_'+clist[j].songid].audio_url=clist[j].m4a;
                        Musics['QQMusic_'+clist[j].songid].picture_small=clist[j].albumpic_small;
                        Musics['QQMusic_'+clist[j].songid].picture_big=clist[j].albumpic_big;

                        Musics['QQMusic_'+clist[j].songid].rx=rj;
                        Musics['QQMusic_'+clist[j].songid].ry=(ri+rj/80*360)%360;
                        Musics['QQMusic_'+clist[j].songid].zindex=++zindex;

                        pano.loadMusic(Musics['QQMusic_'+clist[j].songid]);
                        if(rj>=70){
                            rj=-70;
                            ri+=60;
                        }else{
                            rj+=10;
                        }
                    }
                }else{
                    console.log('error');
                }

            });
        }

        $('#search').focus(function(){
            $(this).addClass('focus');
        });

        $('#search').blur(function(){
            $(this).removeClass('focus');
        });

        function nothing(e){
            e.stopPropagation();
        }
        function moreInfo(e){
            e.stopPropagation();
            e.preventDefault();
            stopSearchAnimation=true;
            $('#search').val($('#music-songname').text());
            search($('#music-songname').text());
            $('#music-details').removeClass('show');
        }
        function hideDetails(){
            $('#music-details').removeClass('show');
        }
        function clearSearch(){
            if(stopSearchAnimation==false){
                $('#search').val('');
                stopSearchAnimation=true;
            }
            if($('#search').val()==autoTyping[0]){
                $('#search').val('');
            }
        }
        $('#search').on('focus',function(){
            $('#search-wrap').addClass('showbtn');
        });

        function switchTab(){
            if(contentScrolling)return;
            $('.tab').removeClass('selected');
            $(this).addClass('selected');
            searchPost();
        }
        function hideResults(){
            $('#result-wrap').removeClass('show');
        }
        function showOthers(){
            var delay=0;
            $('.other-wrap').each(function(){
                var self=$(this);
                setTimeout(function(){
                    self.addClass('show');
                },delay);
                delay+=50;
            });
            $('#result-wrap').removeClass('show');
        }
        function hideOthers(){
             var delay=0;
             $('.other-wrap').each(function(){
                 var self=$(this);
                 setTimeout(function(){
                     self.removeClass('show');
                 },delay);
                 delay+=50;
             });
        }
        function magnifierClick(){
            $('#search').blur();
            if($('#search-wrap').hasClass('show')){
                $('#search-wrap').removeClass('show');
                $('#result-wrap').removeClass('show');
                $('#introduction-wrap').removeClass('show');
                hideOthers();
            }else{
                $('#search-wrap').addClass('show');
                showOthers();
            }
        }

        function hideSearch(){
            $('#search-wrap').removeClass('show');
            $('#search-wrap').removeClass('start');
        }

        function showAbout(){
            hideDetails();
            hideOthers();
            $('#introduction-title').text('<%-language.about%>');
            $('#introduction-wrap').addClass('show');
            $('#introduction-content').html('<%-language.about_content%>');
        }
        function showVolunteer(){
            hideDetails();
            hideOthers();
            $('#introduction-title').text('<%-language.volunteer%>');
            $('#introduction-wrap').addClass('show');
            $('#introduction-content').html('<%-language.volunteer_content%>');
        }
        function hideIntroduction(){
            $('#introduction-wrap').removeClass('show');
        }
        function showHelp(){
            hideDetails();
            hideOthers();
            $('#introduction-title').text('<%-language.help%>');
            $('#introduction-wrap').addClass('show');
            $('#introduction-content').html('<%-language.help_content%>');
        }

        function hideAll(){
            hideOthers();
            hideSearch();
            hideIntroduction();
            hideDetails();
        }

        function showIframe(){
            hideDetails();
            hideResults();
            hideOthers();
            var self=$(this);
            $('#introduction-title').text(self.attr('data-title'));
            $('#introduction-wrap').addClass('show');
            $('#audio')[0].pause();
            $('#introduction-content').html(template('template-youku',{youku_id:self.attr('data-id'),height:$('#introduction-content').height()-20,width:$('#introduction-content').width()-20}));
            player = new YKU.Player('youkuplayer',{
            styleid: '0',
            client_id: '<%=youku_client_id%>',
            vid: self.attr('data-id')
            });
        }

        var contentScrolling=false;
        var maxfov=120,fov=120,minfov=120;

        var result_wrap=$('#result-wrap');
        if(checkMobile()){
            maxfov=100;
            fov=100;
            minfov=100;

            $('#music-details').on('touchstart',hideDetails);
            $('#music-more').on('touchstart',moreInfo);
            $('#music-info').on('touchstart',nothing);
            $('#music-album').on('touchstart',nothing);

            $('#search').on('touchend',clearSearch);
            $('#btn-search').on('touchend',function(){hideDetails();
                $('#introduction-wrap').removeClass('show');
                hideOthers();
            search($('#search').val());});
            $('.tab').on('touchstart',switchTab);
            $('#result-content').on('touchstart',function(){contentScrolling=true;});
            $('#result-content').on('touchend',function(){contentScrolling=false;});
            $('#magnifier').on('touchstart',magnifierClick);
            $('.about').on('touchend',showAbout);
            $('.volunteer').on('touchend',showVolunteer);
            $('.help').on('touchend',showHelp);
            result_wrap.delegate('.result-video','click',showIframe);
        }else{
            $('#music-details').on('mouseup',hideDetails);
            $('#music-more').on('mouseup',moreInfo);
            $('#music-album').on('mouseup',nothing);
            $('#search').on('mouseup',clearSearch);
            $('#btn-search').on('mouseup',function(){hideDetails();
                $('#introduction-wrap').removeClass('show');
                hideOthers();
            search($('#search').val());});
            $('.tab').on('mouseup',switchTab);
            $('#magnifier').on('mouseup',magnifierClick);
            $('.about').on('mouseup',showAbout);
            $('.volunteer').on('mouseup',showVolunteer);
            $('.help').on('mouseup',showHelp);
            result_wrap.delegate('.result-video','click',showIframe);
        }

        function musicClick(content){
            hideOthers();
            hideIntroduction();
            $('#search-wrap').removeClass('show');
                setTimeout(function(){
                    $('#music-album').css('background-image','url('+content.attr('picture_small')+')');
                    $('#music-album-full').css('background-image','url('+content.attr('picture_big')+')');
                    $('#music-songname').text(content.attr('songname'));
                    $('#music-albumname').text(content.attr('albumname'));
                    $('#music-singer').text(content.attr('singer'));
                    $('#music-details').addClass('show');
                },300);
                $('#audio').attr('src',content.attr('audio_url'));
            $('#result-wrap').removeClass('show');
        }

        pano.init({
            dom   : $('#pano'), // Panorama dom
            maxfov: maxfov,     // Max field of view
            minfov: minfov,     // Min field of view
            fov   : fov,        // Default field of view

            musicClick:musicClick,

            autoRotate: 0.1,

            mode      : 'viewer'

        });
</script>

</html>
