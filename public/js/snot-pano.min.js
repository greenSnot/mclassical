/*! Mclassical 2016-02-14 */
/*author:greenSnot@github */    
!function(a){function b(a,b,c){var d=200/distance3D(a,b,c,0,0,0);return[a*d,b*d,c*d]}function c(a,b,c,d){d=d?d:function(){console.log("Preview images loaded")};var e={front:"rotateY(90deg)                rotateZ("+c[0]+"deg)  translateZ(-"+j.cubeSize/2+"px)",bottom:"rotateY(90deg)rotateX(90deg)  rotateZ("+c[1]+"deg)  translateZ(-"+j.cubeSize/2+"px) rotateZ(90deg)",left:"rotateY(90deg)rotateY(90deg)  rotateZ("+c[2]+"deg)  translateZ(-"+j.cubeSize/2+"px)",back:"rotateY(90deg)rotateY(180deg) rotateZ("+c[3]+"deg)  translateZ(-"+j.cubeSize/2+"px)",top:"rotateY(90deg)rotateX(-90deg) rotateZ("+c[4]+"deg)  translateZ(-"+j.cubeSize/2+"px) rotateZ(-90deg)",right:"rotateY(90deg)rotateY(-90deg) rotateZ("+c[5]+"deg)  translateZ(-"+j.cubeSize/2+"px)"},f=0;for(var g in e)$(".cube."+g).css("-webkit-transform",e[g]),$(".cube."+g).css("width",j.cubeSize+2+"px"),$(".cube."+g).css("height",j.cubeSize+2+"px"),$(".cube."+g).attr("src",a[f]),$(".cube."+g).attr("data-index",f),$(".cube."+g)[0].onload=function(){if(k=k>0?k+1:1,6==k)for(var a in e)$(".cube."+a).attr("src",b[$(".cube."+a).attr("data-index")])},f++}function d(){j._animateId=requestAnimationFrame(d),j.pauseAnimation||(e(),TWEEN.update())}function e(){j.frames++,j.ry+=j.autoRotation,i+=j.autoRotation,j.camera.style.webkitTransform="translateZ("+epsilon(j.perspective)+"px) rotateX("+epsilon(j.rx)+"deg) rotateY("+epsilon(j.ry)+"deg)"+j.cameraBaseTransform}var f,g,h,i,j={movingRatio:.3,autoRotation:0,frames:0,imgs_rotation:[0,0,0,0,0,0],pauseAnimation:!1,dom:$("#snot-pano"),cubeSize:1024,ry:0,rx:0,maxfov:120,minfov:60,fov:90},k=0;a.snot=a.snot||j;var l,m,n=function(a){a<j.minfov||a>j.maxfov||(j.fov=a,j.container.style["-webkit-transform"]="scale("+Math.tan(j.maxfov/2*Math.PI/180)/Math.tan(j.fov/2*Math.PI/180)+")")},o=new TWEEN.Tween(j).easing(TWEEN.Easing.Quartic.Out),p=function(a,b){$(".sprite").remove(),k=0,cancelAnimationFrame(j._animateId);for(var e in a)j[e]=a[e];g=leftPos(j.dom[0]),f=topPos(j.dom[0]),h=j.rx,i=j.ry,b||(j.camera=j.dom.find("#camera")[0],j.container=j.dom.find("#container")[0],j.dom.find(".link").each(function(){$(this).remove()}),j.width=j.dom.width(),j.height=j.dom.height(),j.perspective=j.width/2/Math.tan(j.maxfov/2*Math.PI/180),j.container.style["-webkit-perspective"]=j.perspective+"px",j.camera.style["-webkit-transform"]="translateZ("+j.perspective+"px) rotateX("+j.rx+"deg) rotateY("+j.ry+"deg) translateX("+(j.cubeSize-j.width)/-2+"px) translateY("+(j.cubeSize-j.height)/-2+"px)",j.cameraBaseTransform="translateX("+epsilon((j.cubeSize-j.width)/-2)+"px) translateY("+epsilon((j.cubeSize-j.height)/-2)+"px)"),n(j.fov),a.imgs_preview&&c(a.imgs_preview,a.imgs_original,a.imgs_rotation),a&&r(a.sprites),checkMobile()?(j.container.addEventListener("touchstart",v,!1),j.container.addEventListener("touchmove",u,!1),j.container.addEventListener("touchend",x,!1)):(j.container.addEventListener("mousedown",v,!1),j.container.addEventListener("mousemove",u,!1),j.container.addEventListener("mouseup",x,!1),j.container.addEventListener("mousewheel",w,!1)),a.callback&&a.callback(),d()},q={fx:0,fy:0,sx:0,sy:0},r=function(a){for(var c in a){var d=a[c];if(d.standardlization){var e=b(d.x,d.y,d.z);d.x=e[0],d.y=e[1],d.z=e[2]}var f=$(template(d.template,d))[0];f.data=a[c],t(f,d.x,d.y,d.z)}},s=function(a,b,c,d,e){var f=text2Matrix("rotateY("+epsilon(-e)+"deg) rotateX("+epsilon(-d)+"deg) translate3d("+epsilon(a)+"px,"+epsilon(b)+"px,"+epsilon(c)+"px)");return[-parseFloat(f[12]),-parseFloat(f[13]),-parseFloat(f[14])]},t=function(a,b,c,d,e,f){if(d=-d,b=-b,c=-c,void 0!=e&&void 0!=f){var g=s(b,c,d,e,f);return void t(a,g[0],g[1],g[2])}var h=document.createElement("div");h.style.display="inline-block",h.style.position="absolute",h.className="sprite",h.style["-webkit-transform-origin-x"]="0",h.style["-webkit-transform-origin-y"]="0";var i=0==b&&0==d?0:Math.acos(d/Math.pow(b*b+d*d,.5));i=0>b?2*Math.PI-i:i,i=180*i/Math.PI;var k=distance3D(b,c,d,0,0,0);b+=j.cubeSize/2,c+=j.cubeSize/2;var l=text2Matrix("translate3d("+epsilon(b)+"px,"+epsilon(c)+"px,"+epsilon(d)+"px) rotateY("+epsilon(i)+"deg) rotateX("+epsilon((c-j.cubeSize/2)/k*-90)+"deg) rotateY(180deg)");h.style["-webkit-transform"]=matrix2Text(l),h.appendChild(a),j.camera.appendChild(h)},u=function(a){a.preventDefault(),a.stopPropagation();var b=parseInt(a.clientX>=0?a.clientX:a.touches[0].pageX),c=parseInt(a.clientY>=0?a.clientY:a.touches[0].pageY);if(b-=g,c-=f,q.click=!1,!q.onTouching)return!1;if(a.touches&&a.touches.length>1){var d=b,e=c,k=a.touches[1].pageX,l=a.touches[1].pageY,m=distance2D(q.fx,q.fy,q.sx,q.sy)-distance2D(d,e,k,l),n=.12;return j.setFov(j.fov+m*n),q.fx=d,q.fy=e,q.sx=k,q.sy=l,!1}var n=j.movingRatio;i+=(q.fx-b)*n,h-=(q.fy-c)*n,q.fx=b,q.fy=c,h=h>90?90:h,h=-90>h?-90:h,isIphone()||isAndroid()||!isIpad()?o.to({ry:i,rx:h},300).start():(j.camera.style["-webkit-transition"]="all 0.3s ease-out",j.rx=h,j.ry=i)},v=function(a){a.preventDefault(),a.stopPropagation();var b=parseInt(a.clientX>=0?a.clientX:a.touches[0].clientX),c=parseInt(a.clientY>=0?a.clientY:a.touches[0].clientY);b-=g,c-=f,l=b,m=c,q.fx=b,q.fy=c,q.click=!0,a.touches&&a.touches.length>1&&(q.sx=a.touches[1].pageX,q.sy=a.touches[1].pageY),q.onTouching=!0},w=function(a){a.preventDefault(),a.stopPropagation();var b=a.deltaY;j.setFov(j.fov+.06*b)},x=function(a){a.preventDefault(),a.stopPropagation();var b=parseInt(a.clientX>=0?a.clientX:a.changedTouches[0].pageX),c=parseInt(a.clientY>=0?a.clientY:a.changedTouches[0].pageY);if(b-=g,c-=f,distance2D(l,m,b,c)<5){var d=100,e=(b/j.width-.5)*j.fov,h=(c/j.height-.5)*j.fov*j.height/j.width,i=Math.cos(j.fov/2*Math.PI/180)*j.cubeSize,k=(b-j.width/2)/j.width*2,n=(c-j.height/2)/j.width*2,o=Math.sin(j.fov/2*Math.PI/180)*j.cubeSize;e=Math.atan(k*o/i),h=Math.atan(n*o/i),e*=180/Math.PI,h*=180/Math.PI;var p,r=rotation2Position(d,h,0),t=distance3D(-Math.tan(e*Math.PI/180)*r[2],-r[1],r[2],0,0,0),u=d/t,v=s(-Math.tan(e*Math.PI/180)*r[2]*u,-r[1]*u,r[2]*u,j.rx,j.ry),w=-v[0],x=-v[1],y=-v[2],z=j.minDetectDistance;$(".sprite").each(function(){var a=text2Matrix($(this)[0].style.webkitTransform),b=100/distance3D(0,0,0,j.cubeSize/2-a[12],a[13]-j.cubeSize/2,-a[14]),c=distance3D(w,-x,y,(j.cubeSize/2-a[12])*b,b*(a[13]-j.cubeSize/2),b*-a[14]);z>c&&(z=c,p=$(this).children().eq(0))});var v=position2rotation(w,y,x);p?j.onSpriteClick(p[0].data,p[0]):j.onClick(w,x,y,v[0],v[1])}q.onTouching=!1},y=function(a,b){a=parseFloat(a),b?(h=a,o.to({ry:i,rx:h},300).start()):j.rx=a},z=function(a,b){a=parseFloat(a),b?(a-j.ry%360>180&&(j.ry+=360),j.ry%360-a>180&&(j.ry-=360),i=a,console.log("ry:"+i),console.log("panory:"+j.ry),o.to({ry:i,rx:h},300).start()):pano.ry=a};$.extend(a.snot,{setFov:n,setRx:y,setRy:z,init:p,loadSprites:r})}(window);