<!DOCTYPE html>
<html lang="en">
	<head>
		<title>panorama demo</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<style>
			body {
				margin: 0px;
				overflow: hidden;
			}
            .p-img{display:none}
		</style>
	</head>
	<body>

		<div id="container">
            <img class="p-img">
            <img class="p-img">
            <img class="p-img">
            <img class="p-img">
            <img class="p-img">
            <img class="p-img">
        </div>


        <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r71/three.min.js"></script>

		<script src="../js/zepto.min.js"></script>
		<script src="../js/sti-pano-utils.min.js"></script>
		<script src="../js/sti-common.min.js"></script>

		<script>
$(function(){
        var config={
            scene_key:'e9bb6c580d7a5e53bb8887fc8228bce91d93a20d',
            cdnImagesPath:'http://7xiljm.com1.z0.glb.clouddn.com/images'
        }

        function v3(a,b,c){return new THREE.Vector3(a,b,c)}
        function f3(a,b,c){return new THREE.Face3(a,b,c)}
        PI=Math.PI
    console.log( "I never saved anything for the swim back." );

    if ( config.debug ) {

        console.log( THREE );
        console.log( new THREE.Object3D() );

    }

    window.scene;
    window.camera;

    var renderer ,stats ,container = $( '#container' );
    var pauseAnimation = false;
    var spriteRY, spriteRX;
    var spriteVec;
    var commentScale = 0.5;

    var maxFov = 120, minFov = 90;
    if(config.type=='edit'){
        minFov=60;
    }
    var css3BoxSize = 1024;
    var camerax = 0, cameray = 0, cameraz = 0;
    var isUserInteracting = false;
    var onMouseDownMouseX = 0, onMouseDownMouseY = 0;
    var lon = 0, onMouseDownLon = 0;
    var lat = 0, onMouseDownLat = 0;
    var phi = 0, theta = 0;
    var downx, downy;

    var detectlist = [];

    var firstMultiTouch = true;//多点触摸首次点击
    var multix1, multix2, multiy1, multiy2;//多点触摸 上一次点击
    var multix3, multix4, multiy3, multiy4;//多点触摸 这一次点击

    var sphereImage = THREE.Texture();
    var pictureName = 'allinone.jpg';

    var sceneImages = [];
    var sceneImagesCounter = 0;

    var ctx=[];
    var HQimg=[];
    var LQimg=[];
    var LQ_COUNTER=0;
    var HQ_COUNTER=0;

    //链接类型
    var icon_type = {
        0:'straight',
        1:'left',
        2:'right',
        3:'upleft',
        4:'upright',
        5:'dotone',
        6:'dottwo',
        7:'finger',
        8:'magnifier',
        9:'down'
    };
    var imgUrls=[
                config.localImagesPath+'/negx.jpg',
                config.localImagesPath+'/negy.jpg',
                config.localImagesPath+'/negz.jpg',
                config.localImagesPath+'/posx.jpg',
                config.localImagesPath+'/posy.jpg',
                config.localImagesPath+'/posz.jpg'
        ];

    function flushSkin(){
        for ( var i = 0 ; i < 6 ; ++i ) {

            var element;

                element=$('.p-img')[i];
                element.crossOrigin='*';
                element.style.height= css3BoxSize + 2+'px';
                element.style.width= css3BoxSize + 2 +'px';

                HQimg[i]=new Image();
                HQimg[i].className="p-hq-img";
                HQimg[i].crossOrigin='*';
                HQimg[i].src=config.cdnImagesPath + '/scenes/' + config.scene_key + '/' + pictureName + '?imageMogr2/gravity/NorthWest/crop/!' + css3BoxSize + 'x' + css3BoxSize + 'a0a' + ( css3BoxSize * i ) + '/interlace/0/thumbnail/!100p';
                HQimg[i].index=i;

                if(HQimg[i].complete){
                    $('.p-img')[i].src=HQimg[i].src;
                }else{
                    HQimg[i].onload=function(){
                        $('.p-img')[$(this)[0].index].src=$(this)[0].src;
                    }
                    HQimg[i].onerror=function(){
                        if(confirm('图片加载失败,请重新打开页面')){
                            location.reload();
                        }
                    }
                }


            element.style.zIndex=1;
            sceneImages.push(element);
        }
    }

    window.addEventListener('load',function(){
        flushSkin();
        init();
        animate();
    },false);

    function gen_panorama_webgl_cube(){
        THREE.ImageUtils.crossOrigin='*';
        sphereImage=THREE.ImageUtils.loadTexture(config.imgUrl);
        var geometry = new THREE.BoxGeometry( 100, 100, 100 );
        //geometry.applyMatrix( new THREE.Matrix4().makeScale( -1, 1, 1 ) );
        var material = new THREE.MeshBasicMaterial( {
            map: sphereImage,
            side:THREE.DoubleSide
        } );
        return new THREE.Mesh( geometry, material );
    }

    function gen_panorama_webgl_sphere(){
        THREE.ImageUtils.crossOrigin='*';
        sphereImage=THREE.ImageUtils.loadTexture(config.imgUrl);
        var geometry = new THREE.SphereGeometry( 100, 20, 20 );
        geometry.applyMatrix( new THREE.Matrix4().makeScale( -1, 1, 1 ) );
        var material = new THREE.MeshBasicMaterial( {
            map: sphereImage
        } );
        return new THREE.Mesh( geometry, material );
    }

    function gen_line(x,y,z,x2,y2,z2){
        if(config.useCSS3D){
        }else{
            var Geo_line=new THREE.Geometry();
            var Mat_line=new THREE.LineBasicMaterial({vertexColrs:THREE.VertexColors});
            Geo_line.vertices.push(new THREE.Vector3(x,y,z));
            Geo_line.vertices.push(new THREE.Vector3(x2,y2,z2));
            Geo_line.colors.push(new THREE.Color(0x444444),new THREE.Color(0xFF0000));
            return new THREE.Line(Geo_line,Mat_line,THREE.LinePieces);
        }
    }
    function gen_cube(x,y,z,size){
        var geometry = new THREE.BoxGeometry(size,size,size);
        var material = new THREE.MeshBasicMaterial({color: 0x00ff00});
        var cube=new THREE.Mesh(geometry, material);
        cube.position.x=x;
        cube.position.y=y;
        cube.position.z=z;
        return cube;
    }

    function gen_ambientLight(){
        var ambiColor = "#0c0c0c";
        var ambientLight = new THREE.AmbientLight(ambiColor);
        return ambientLight;
    }
    function gen_spotLight(){
        var spotLight = new THREE.SpotLight(0xffffff);
        spotLight.position.set(40, 60, 10);
        spotLight.castShadow = true;
        return spotLight;
    }
    function gen_arrow(x,y,z,s,angleY,angleZ){
        var a=0.5,b=1,c=0.5,d=1;
        var vertices= [
            v3(-s*c,0,0),
            v3(-s*c,0,-s*b),
            v3(s*c,0,-s*b),
            v3(s*c,0,0),
            v3(s*c+s*a,0,0),
            v3(0,0,s*d),
            v3(-s*c-s*a,0,0)
                ];

        var faces= [
            f3(2,1,0),
            f3(3,2,0),
            f3(6,5,4)
                ];

        var geometry= new THREE.Geometry();
        var materials = [
            new THREE.MeshLambertMaterial({opacity: 0.6, color: 0xffffff, transparent: true})
            //new THREE.MeshBasicMaterial({color: 0x00ff00, wireframe: false, opacity:0.7,transparent:true})
            ];
        geometry.vertices=vertices;
        geometry.faces=faces;
        geometry.computeFaceNormals();

        var mesh= THREE.SceneUtils.createMultiMaterialObject(geometry,materials);
        mesh.children.forEach(function (e) {
            e.castShadow = true
        });

        mesh.position.x=x;
        mesh.position.y=y;
        mesh.position.z=z;

        var arc=Math.acos(z/Math.pow(x*x+z*z,0.5));
        if(x<0){
            arc=2*PI-arc;
        }

        mesh.rotation.y=arc+angleY*PI/180;
        if(angleZ){
            mesh.rotation.z=angleZ*PI/180;
        }

        return mesh;
    }
    function gen_stats(){
        stats = new Stats();
        stats.domElement.style.position = 'absolute';
        stats.domElement.style.top = '0px';
        stats.domElement.style.zIndex= '10000';
        return ( stats.domElement );
    }
    function gen_text(x,y,z,text,size){
        textWidth=text_length(text)/2*size;
        textHeight=size;
        var rate=20;
        var canvas = document.createElement("canvas");
        var context=canvas.getContext('2d');
        canvas.style.position='absolute';
        canvas.width=textWidth;
        canvas.height=textHeight;


        canvas.style.bottom=0;
        canvas.style.left=0;
        context=canvas.getContext('2d');
        context.font = size+"px impact";
        context.fillStyle = '#fff';
        context.textAlign='center';
        context.shadowColor = 'rgba(0,0,0,1)';
        context.shadowOffestX= 95;
        context.shadowOffestX= -90;
        context.textBaseline='middle';
        context.fillText(text,textWidth/2,textHeight/2);

        var geom=new THREE.PlaneGeometry(context.measureText(text).width/rate,size/rate, 1, 1);
        var cTexture=new THREE.Texture(canvas);
        var mat = new THREE.MeshBasicMaterial({map:cTexture,transparent:true});
        cTexture.needsUpdate=true;
        var mesh = new THREE.Mesh(geom, mat);

        mesh.position.set(x,y,z);
        var arc=Math.acos(z/Math.pow(x*x+z*z,0.5));
        if(x<0){
            arc=2*PI-arc;
        }

        mesh.rotation.y=arc+PI;

        return mesh;
    }
    function advertisementClick(){
    }
    function init() {
            camera = new THREE.PerspectiveCamera( 120, window.innerWidth / window.innerHeight, 1, 1000 );
            container.css('-webkit-transform','scale('+(120/65)+')');
            camera.target = new THREE.Vector3( 0, 0, 0 );

            scene = new THREE.Scene();

            if(config.debug){
                container.append(gen_stats());
            }

            try{
                renderer = new THREE.WebGLRenderer();
            }catch(e){
                log(e);
                alert('您的浏览器太捞');
            }

            try{
                renderer.setPixelRatio( window.devicePixelRatio );
            }catch(e){
                log(e);
            }

            detectlist.push(gen_panorama_webgl_cube());
            scene.add( detectlist[0] );

            scene.add(gen_arrow(20,-10,0,10,0,00));
            scene.add(gen_arrow(20,-10,0,10,0,90));
            scene.add(gen_arrow(20,-10,0,10,0,180));
            scene.add(gen_arrow(20,-10,0,10,0,270));
            scene.add( gen_ambientLight() );
            scene.add( gen_spotLight() );
            scene.add( gen_line(0,0,0,0,0,100) );
            scene.add( gen_line(0,0,0,0,100,0) );
            scene.add( gen_line(0,0,0,100,0,0) );

        renderer.setSize( window.innerWidth, window.innerHeight );
        container.append( renderer.domElement );

        if(checkMobile()){
            container.on ( 'touchstart', onDocumentMouseDown, false );
            container.on ( 'touchmove', onDocumentMouseMove, false );
            container.on ( 'touchend', onDocumentMouseUp, false );
        }else{
            container.on ( 'mousedown', onDocumentMouseDown, false );
            container.on ( 'mousemove', onDocumentMouseMove, false );
            container.on ( 'mouseup', onDocumentMouseUp, false );
        }

    }

    function onDocumentMouseDown( event ) {
        event.preventDefault();
        if(pauseAnimation){return false;}
        isUserInteracting = true;

        onPointerDownPointerX = parseInt(event.clientX>=0?event.clientX:event.targetTouches[0].clientX);
        onPointerDownPointerY = parseInt(event.clientY>=0?event.clientY:event.targetTouches[0].clientY);
        onPointerDownLon = lon;
        onPointerDownLat = lat;

        downx=onPointerDownPointerX;
        downy=onPointerDownPointerY;
    }
    function onDocumentMouseMove( event ) {
        if(pauseAnimation){return false;}

        try{
            var x=parseInt(event.clientX>=0?event.clientX:event.targetTouches[0].clientX);
            var y=parseInt(event.clientY>=0?event.clientY:event.targetTouches[0].clientY);
        }catch(e){
            log(e);
        }
        if (event.touches&&event.touches.length>1) {
            if(firstMultiTouch){
                Multix1=event.touches[0].pageX;
                Multiy1=event.touches[0].pageY;
                Multix2=event.touches[1].pageX;
                Multiy2=event.touches[1].pageY;
                firstMultiTouch=false;
            }else{
                Multix3=event.touches[0].pageX;
                Multiy3=event.touches[0].pageY;
                Multix4=event.touches[1].pageX;
                Multiy4=event.touches[1].pageY;

                var change=abs(Multix1-Multix2)+abs(Multiy1-Multiy2) - abs(Multix3-Multix4)-abs(Multiy3-Multiy4);
                var step=1+abs(change/4);
                if(change>0){
                    if(isAndroid()){
                        var ascale=parseFloat(getFloat(container.css('-webkit-transform')));
                        ascale-=step*0.02;
                        ascale=ascale<1?1:ascale;
                        container.css('-webkit-transform','scale('+ascale+')');
                    }else{
                        camera.fov=camera.fov+step>maxFov?maxFov:camera.fov+step;
                        camera.updateProjectionMatrix();
                    }
                }else if(change<0){
                    if(isAndroid()){
                        var ascale=parseFloat(getFloat(container.css('-webkit-transform')));
                        ascale+=step*0.02;
                        if(config.type=='edit'){
                            ascale=ascale<2.5?ascale:2.5;
                        }else{
                            ascale=ascale<1.5?ascale:1.5;
                        }
                        container.css('-webkit-transform','scale('+ascale+')');
                    }else{
                        camera.fov=camera.fov-step<minFov?minFov:camera.fov-step;
                        camera.updateProjectionMatrix();
                    }
                }
                if(change!=0){
                    firstMultiTouch=true;
                }
            }
        }else{
            if ( isUserInteracting === true ) {
                var step=0.2;
                lon = ( onPointerDownPointerX - x ) * step + onPointerDownLon;
                lat = ( y - onPointerDownPointerY ) * step + onPointerDownLat;
            }
        }
    }
    function onDocumentKeyDown( event ){
        if(!pauseAnimation){
            //a65 s83 d68 w87 q81 e69
            var ox=camera.target.x-camera.position.x;
            var oy=camera.target.y-camera.position.y;
            var oz=camera.target.z-camera.position.z;

            var step=3;
            if(event.keyCode==83){
                camerax-=step*ox;
                cameray-=step*oy;
                cameraz-=step*oz;
            }else if(event.keyCode==68){
                camerax-=step*oz;
                cameraz+=step*ox;
            }else if(event.keyCode==65){
                camerax+=step*oz;
                cameraz-=step*ox;
            }else if(event.keyCode==87){
                camerax+=step*ox;
                cameray+=step*oy;
                cameraz+=step*oz;
            }else if(event.keyCode==81){
                cameray+=step;
            }else if(event.keyCode==69){
                cameray-=step;
            }else if(event.keyCode==90){
                var ascale=parseFloat(getFloat(container.css('-webkit-transform')));
                ascale-=0.1;
                container.css('-webkit-transform','scale('+ascale+')');
            }else if(event.keyCode==88){
                var ascale=parseFloat(getFloat(container.css('-webkit-transform')));
                ascale+=0.1;
                ascale=ascale<2.5?ascale:2.5;
                container.css('-webkit-transform','scale('+ascale+')');
            }
        }
    }
    function m4(){
        return new THREE.Matrix4();
    }

    var objectDeleting=false;

    function mapSpotClick(self){
        $.ajax({
            type:'GET',
            url:'/scene?key='+self.attr('key')+'&groupkey='+config.groupkey+'&type=json',
            async:false,
            success:function(r){
                switchFunction(
                    $( '.map-switch' ),
                    function(){$('.maps-wrap').hide();},
                    function(){$('.maps-wrap').show();}
                );
                loadAll(r);
            }
        });
    }

    var loadAll=function(r){
        if(r.code!=0){
            alert(r.msg);
            return;
        }

        //更新config
        config.scene_key=r.scene_key;
        config.groupkey=r.groupkey;

        //更新Map
        $('.map-spot').removeClass('current');
        $('.map-spot[key="'+config.scene_key+'"]').addClass('current');

        //加载遮罩
        $('.loader').show();

        //更新标题
        $('#title').text(r.title);

        //更新visited
        $('#visited').text(r.visited);

        //更新图片
        for(var i =0;i<6;++i){
            LQimg[i]=new Image();
            LQimg[i].src=config.cdnImagesPath + '/scenes/' + config.scene_key + '/' + pictureName + '?imageMogr2/gravity/NorthWest/crop/!' + css3BoxSize + 'x' + css3BoxSize + 'a0a' + ( css3BoxSize * i ) + '/interlace/0/thumbnail/!10p';
            LQimg[i].index=i;
            LQimg[i].onload=function(){
                ++LQ_COUNTER;
                if(LQ_COUNTER==6){
                    for(var j=0;j<6;++j){
                        $('.p-img')[j].src=LQimg[j].src;
                    }
                    //缩略图加载完成
                    LQ_COUNTER=0;

                    //更新初始视角
                    lon=r.view;

                    $('.loader').hide();

                    updateSprites();

                    //加载高清图
                    for(var j=0;j<6;++j){
                        HQimg[j]=new Image();
                        HQimg[j].src=config.cdnImagesPath + '/scenes/' + config.scene_key + '/' + pictureName + '?imageMogr2/gravity/NorthWest/crop/!' + css3BoxSize + 'x' + css3BoxSize + 'a0a' + ( css3BoxSize * j ) + '/interlace/0/thumbnail/!100p';
                        HQimg[j].index=j;
                        HQimg[j].onload=function(){
                            ++HQ_COUNTER;
                            $('.p-img')[$(this)[0].index].src=HQimg[$(this)[0].index].src;
                            if(HQ_COUNTER==6){
                                HQ_COUNTER=0;
                            }
                        }

                    }

                }
            }
        }

        function updateSprites(){
            //更新链接
            //删除所有link comment 等等sprite
            $('[type=sprite]').each(function(){
                var object=scene.getObjectByName($(this).attr('id'));
                scene.remove(object);
            });
            config.links=JSON.stringify(r.links);
            config.comments=JSON.stringify(r.comments);
            prepareSprites();

            //加载链接
            for(var i=0;i<preload_links.length;++i){
                addSprite(
                        gen_element('spot_'+icon_type[preload_links[i].type],preload_links[i].text,preload_links[i].id,i,preload_links[i].scene_key),
                        preload_links[i].position_x,preload_links[i].position_y,preload_links[i].position_z
                        );
            }
            //加载评论
            if(preload_comments&&config.type!='edit'){
                for(var i =0; i<preload_comments.length;++i){
                    var ele=gen_element('comment',preload_comments[i].text,preload_comments[i].id,i);
                    addSprite(ele,preload_comments[i].position_x,preload_comments[i].position_y,preload_comments[i].position_z);
                }
            }
        }

    }

    var spotClick=function(self){
        if(config.type!='edit'){
            //直接跳转
            //location.href='/scene?key='+self.attr("extra")+'&groupkey='+config.groupkey;

            $.ajax({
                type:'GET',
                url:'/scene?key='+self.attr('extra')+'&groupkey='+config.groupkey+'&type=json',
                async:false,
                success:loadAll
            });
        }else{
            $('.romaing-editor').show();
            $('.romaing-editor').find('.buttons').addClass('hide');
            $('.romaing-editor').find('.editor-modify').removeClass('hide');
            $('.romaing-editor').attr('current-id',getInt(self[0].id));
            $('.romaing-editor').attr('current-dom-id',self[0].id);
        }
    }


    function addSprite(element,x,y,z,rotation_x){
        var distance=Math.pow(x*x+y*y+z*z,0.5);
        var object = new THREE.CSS3DObject(element);
        rotation_x=rotation_x?rotation_x:0;
        var t=m4().setPosition(v3(0,0,-distance*commentScale));

        var getarc=function(x,z){
            var arc=Math.acos(z/Math.pow(x*x+z*z,0.5));
            return x<0?2*PI-arc:arc;
        }

        if(rotation_x){
            object.matrix.makeRotationX(rotation_x);
        }else{
            object.matrix.makeRotationX(y/distance*PI/2);
        }
        object.matrix.multiplyMatrices(m4().makeRotationY(getarc(x,z)+PI),object.matrix);
        object.matrix.elements[12]=x;
        object.matrix.elements[13]=y;
        object.matrix.elements[14]=z;

        if(element.id){
            object.name=element.id;
        }

        for(var i=0;i<12;++i){
            object.matrix.elements[i]*=commentScale;
        }
        object.matrixAutoUpdate=false;
        scene.add(object);
    }

    function Distance(x,y,z){
        return Math.pow(x*x+y*y+z*z,0.5);
    }

    function onDocumentMouseUp( event ) {
        if(pauseAnimation){return false;}
        firstMultiTouch=true;
        try{
            var x=parseInt(event.clientX?event.clientX:event.changedTouches[0].clientX);
            var y=parseInt(event.clientY?event.clientY:event.changedTouches[0].clientY);
        }catch(e){
            log(e);
        }
        isUserInteracting = false;

        if(x==downx&&y==downy&&!config.local){//单击

            var mouse = new THREE.Vector2();
            mouse.x = ( x/ window.innerWidth) * 2 - 1;
            mouse.y = - ( y/ window.innerHeight ) * 2 + 1;
            if(config.useCSS3D){
                    var sx=x;
                    var sy=y;

                    var fov=camera.fov;
                    var X=window.innerWidth;
                    var Y=window.innerHeight;
                    var CX=container.width();
                    var CY=container.height();

                    if(isAndroid()){
                        var ascale=parseFloat(getFloat(container.css('-webkit-transform')));
                        ascale=(ascale-1)/2+1;
                        spriteRY=-(sx-X/2)/Y*fov*PI/180 * window.innerHeight/CY *ascale;
                        spriteRX=(Y/2-sy)/Y*fov*PI/180 * window.innerWidth/CX *ascale;
                    }else{
                        spriteRY=-(sx-X/2)/Y*fov*PI/180 * window.innerHeight/CY;
                        spriteRX=(Y/2-sy)/Y*fov*PI/180 * window.innerWidth/CX;
                    }

                    var distance=css3BoxSize/3;

                    var temp=m4();
                    var ry=new THREE.Matrix4().makeRotationY(spriteRY+PI/2);
                    var rxry=ry.multiply(m4().makeRotationZ(spriteRX));

                    var cam=m4().fromArray(camera.matrix.clone().elements);
                    temp.makeRotationY(-PI/2);
                    temp.multiplyMatrices(rxry,temp);
                    temp.multiplyMatrices(cam,temp);

                    spriteVec=v3(0,0,-distance*commentScale).applyProjection(temp);

                    //test
                    //var ele=gen_element('comment','324','3434','?');
                    //addSprite(ele,spriteVec.x,spriteVec.y,spriteVec.z);
                    //return;
                    pauseAnimation=true;

                    var minDistance=100;

                    var minElement;
                    $('[type=sprite]').each(function(){
                        var temp=($(this).css('-webkit-transform')).split(',');
                        var d=Distance(spriteVec.x*commentScale*0.8-temp[14],spriteVec.y*commentScale*0.8-temp[15],spriteVec.z*commentScale*0.8-temp[16]);
                        if(d<minDistance){
                            minElement=$(this);
                            minDistance=d;
                        }
                    });

                    var th=70;
                    if(config.type=='edit'){
                        //th=68.6;
                    }
                    if(minDistance<th&&config.type!='edit'){
                        if(minElement[0].id.indexOf('spot')==0){
                            spotClick(minElement);
                        }else if(minElement[0].id.indexOf('comment')==0){
                            commentClick(minElement);
                        }
                        pauseAnimation=false;
                        return;
                    }

                    if(config.type=='edit'){
                        if($('.btn-mode-add').hasClass('selected')){
                            spriteVec.x*=0.8;
                            spriteVec.y*=0.8;
                            spriteVec.z*=0.8;
                            $('.romaing-editor').show();
                            $('.romaing-editor').find('.buttons').addClass('hide');
                            $('.romaing-editor').find('.editor-add').removeClass('hide');
                            if($('.item')){
                                $('.item').eq(0).click();
                            }
                        }else{
                            if(minDistance<th){
                                $('.romaing-editor').attr('current-id',getInt(minElement[0].id));
                                $('.romaing-editor').attr('current-dom-id',minElement[0].id);
                                editDeleteFunction();
                            }
                        }
                        pauseAnimation=false;
                    }else{

                        //屏蔽评论功能
                        pauseAnimation = false;
                        return;

                        initAlert('comment',{
                            title:'添加评论',
                            buttons:[
                        {
                            text:'取消',
                            className:'btn-comment-cancel',
                            callBack:function(){
                                $('.textarea-comment').blur();
                                $('.alert-wrap').css('visibility','hidden');
                                pauseAnimation=false;
                            }
                        },
                            {
                                text:'评论',
                            className:'btn-comment-post',
                            color:'red',
                            callBack:function(){
                                if($('.textarea-comment').val().length==0){
                                    $('.textarea-comment').attr('placeholder','评论不能为空');
                                    return;
                                }
                                $('.textarea-comment').blur();
                                $.ajax({
                                    url:'/comment-post',
                                    type:'POST',
                                    async:false,
                                    timeout:1000,
                                    data:{
                                        position_x:spriteVec.x,
                                        position_y:spriteVec.y,
                                        position_z:spriteVec.z,
                                        text:$('.textarea-comment').val(),
                                        reply_id:0,
                                        scene_key:config.scene_key,
                                        group_key:config.groupkey
                                    },
                                    success:function(result){
                                        if(result.code!='0'){
                                            alert(result.msg);
                                            return;
                                        }
                                        $('.alert-wrap').css('visibility','hidden');

                                        if($('.wechat-head').length!=0){
                                            $('head').append("<style>#comment_id_"+result.id+":before{ background-image:"+$('.wechat-head').css('background-image')+" }</style>");
                                        }

                                        var ele=gen_element('comment',$('.textarea-comment').val(),result.id,'?');

                                        addSprite(ele,spriteVec.x,spriteVec.y,spriteVec.z);

                                        pauseAnimation=false;
                                    },
                                    error:function(e){
                                        alert(e);
                                    }
                                });
                            }
                            }
                        ]
                        });
                        $('.alert-wrap').css('visibility','visible');
                        //$('.textarea-comment').focus();
                    }

                return;
            }else{//webgl
                var raycaster=new THREE.Raycaster();
                raycaster.setFromCamera( mouse, camera );
                var intersects = raycaster.intersectObjects( detectlist );
                if ( intersects.length ==1 ) {
                    points=intersects[0].point;
                    scene.add(gen_arrow(points.x*0.85,points.y*0.85,points.z*0.85,10,0,0));
                }
            }
        }
    }

    function animate() {
        requestAnimationFrame( animate );
        update();
    }

    var gif_offset=3200;
    var Frames=0;
    function update() {
        if ( isUserInteracting === false && config.autoRotate &&config.type!='edit') {
            lon += 0.1;
        }

        ++Frames;

        lat = Math.max( - 85, Math.min( 85, lat ) );
        phi = THREE.Math.degToRad( 90 - lat );
        theta = THREE.Math.degToRad( lon );

        camera.MatrixAutoupdate=false;

        camera.target.x =  Math.sin( phi ) * Math.cos( theta )+camerax;
        camera.target.y =  Math.cos( phi )+cameray;
        camera.target.z =  Math.sin( phi ) * Math.sin( theta )+cameraz;

        camera.position.z=cameraz;
        camera.position.y=cameray;
        camera.position.x=camerax;

        camera.lookAt( camera.target );
        camera.updateMatrix();

        renderer.render( scene, camera );
    }

});
		</script>
	</body>
</html>
